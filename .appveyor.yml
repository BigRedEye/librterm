os: Visual Studio 2015

artifacts:
    - path: release
      name: MinGW-w64
      type: zip

deploy:
    - provider: GitHub
      auth_token:
          secure: sWX4wYH0ZYhsKcO3KuQfsIg46ToY2A7YsRjmumo2PugdMdEtAWxr/yqMQGIOci9S
      artifact: MinGW-w64
      prerelease: true
      on:
          branch: master
          appveyor_repo_tag: true

install:
    - git submodule update --init --recursive

    - set INSTALL_PATH=C:\deps\
    - mkdir %INSTALL_PATH%
    - appveyor DownloadFile https://www.libsdl.org/release/SDL2-devel-2.0.9-mingw.tar.gz
    - 7z x SDL2-devel-2.0.9-mingw.tar.gz
    - 7z x SDL2-devel-2.0.9-mingw.tar
    - xcopy SDL2-2.0.9\x86_64-w64-mingw32 %INSTALL_PATH% /s/e/y

    - appveyor DownloadFile https://www.libsdl.org/projects/SDL_image/release/SDL2_image-devel-2.0.4-mingw.tar.gz
    - 7z x SDL2_image-devel-2.0.4-mingw.tar.gz
    - 7z x SDL2_image-devel-2.0.4-mingw.tar
    - xcopy SDL2_image-2.0.4\x86_64-w64-mingw32 %INSTALL_PATH% /s/e/y

    - appveyor DownloadFile https://www.libsdl.org/projects/SDL_ttf/release/SDL2_ttf-devel-2.0.14-mingw.tar.gz
    - 7z x SDL2_ttf-devel-2.0.14-mingw.tar.gz
    - 7z x SDL2_ttf-devel-2.0.14-mingw.tar
    - xcopy SDL2_ttf-2.0.14\x86_64-w64-mingw32 %INSTALL_PATH% /s/e/y

    - dir /B %INSTALL_PATH%
    - dir /B %INSTALL_PATH%\bin

    - set MINGW=C:\mingw-w64\x86_64-7.2.0-posix-seh-rt_v5-rev1\mingw64
    - set PATH=%PATH:C:\Program Files\Git\usr\bin;=%
    - set PATH=%MINGW%\bin;%MINGW%\lib;%INSTALL_PATH%\bin;%PATH%

    - where zlib1.dll
    - where SDL2.dll
    - where libpng16-16.dll
    - for /f %%f in ('where zlib1.dll') do copy %INSTALL_PATH%\bin\zlib1.dll %%f
    - where zlib1.dll

build_script:

    - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

    - mkdir %APPVEYOR_BUILD_FOLDER%\build
    - cd %APPVEYOR_BUILD_FOLDER%\build

    - cmake .. -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -DRTERM_BUILD_TESTS=ON -DRTERM_SDL2_PATH=%INSTALL_PATH% -DBUILD_SHARED_LIBS=ON
    - cmake --build .

    - copy librterm.dll test\
    - copy C:\deps\bin\libpng16-16.dll test\
    - cd test

    - benchmark.exe
    - cd ..

after_build:
    - mkdir release
    - mkdir release\bin
    - mkdir release\lib
    - mkdir release\include
    - mkdir release\include\rterm
    - copy librterm.dll release\bin\
    - copy librterm.dll.a release\lib\
    - copy include release\include\rterm\
